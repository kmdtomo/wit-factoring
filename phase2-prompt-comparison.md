# Phase 2 プロンプト簡略化: 現在 vs 簡略版

## 📊 全体の比較

| 項目 | 現在 | 簡略版 | 削減率 |
|------|------|--------|--------|
| プロンプト総行数 | 約230行 | 約120行 | **-48%** |
| Few-Shot Examples | 6個 | 2個 | **-67%** |
| ギャンブル検出ルール | 約70行 | 約30行 | **-57%** |
| 担保照合ルール | 約100行 | 約50行 | **-50%** |

---

## 1️⃣ Few-Shot Examples の削減

### 【現在】ギャンブル検出 Few-Shot（6個）

```plaintext
【Few-Shot Examples（必ず参考にしてください）】

## 正例1: 直接送金（検出対象）
**入力:**
取引: 2025-08-15、-50,000円、「ウィンチケット」

**正しい判定:**
検出する
{
  "date": "08-15",
  "amount": -50000,
  "destination": "ウィンチケット",
  "keyword": "ウィンチケット"
}

## 正例2: クレジットカード経由（検出対象外）
**入力:**
取引: 2025-08-20、-30,000円、「SMBC カード ウィンチケット」

**正しい判定:**
検出しない（クレジットカード会社経由のため）

## 正例3: 決済代行業者経由（検出対象外）
**入力:**
取引: 2025-09-05、-20,000円、「GMOペイメント マルハン」

**正しい判定:**
検出しない（決済代行業者経由のため）

## 正例4: 企業名に偶然含まれる（検出対象外）
**入力:**
取引: 2025-08-10、-100,000円、「マルハニチロ株式会社」

**正しい判定:**
検出しない（食品会社であり、「マルハン」とは無関係）

## 正例5: 税金・公金サービス経由（検出対象外）
**入力:**
取引: 2025-08-25、-15,000円、「RKS 地方税 ナンバーズ」

**正しい判定:**
検出しない（税金・公金サービス経由のため）

## 正例6: 銀行口座振替（検出対象外）
**入力:**
取引: 2025-09-01、-25,000円、「口座振替 ベラジョン」

**正しい判定:**
検出しない（銀行口座振替のため）

## 誤例: クレジットカード経由を誤検出（避けるべき）
**入力:**
取引: 2025-08-20、-30,000円、「SMBC カード ウィンチケット」

**❌ 誤った判定（避ける）:**
検出する（「ウィンチケット」が含まれているため）

**✅ 正しい判定:**
検出しない（クレジットカード会社（SMBC）経由のため）
```

### 【簡略版】ギャンブル検出 Few-Shot（2個）

```plaintext
【Few-Shot Examples】

例1: 直接送金 → 検出
取引: 2025-08-15、-50,000円、「ウィンチケット」
→ {"date": "08-15", "amount": -50000, "destination": "ウィンチケット", "keyword": "ウィンチケット"}

例2: クレカ/決済代行経由 → 検出しない
取引: 2025-08-20、-30,000円、「SMBC カード ウィンチケット」
→ 検出しない（SMBC経由）
```

**削減効果**: 約60行 → 約10行（**-83%**）

---

## 2️⃣ ルール説明の簡潔化

### 【現在】担保照合ルール（約100行）

```plaintext
2. 【フェーズ1: 全取引の抽出】
   - **企業名マッチングの原則（最重要）:**
     1. **金額を最優先**として照合する
     2. 金額が一致（±1,000円以内）している場合、企業名は部分一致でOK
     3. スマホ画面OCRでは企業名が途切れる可能性を考慮
        - 例: Kintone「山田建設」 ↔ 通帳「（カ）ヤマダケ」→ 金額一致なら一致
        - 例: Kintone「株式会社ABC工務店」 ↔ 通帳「ABC」→ 金額一致なら一致
        - 例: Kintone「田中商事」 ↔ 通帳「タナカ」→ 金額一致なら一致
     4. 企業名の表記ゆれも考慮（法人格、カナ/漢字、略称を無視）
   - 各担保企業からの全入金取引を抽出
   - **重要**: allTransactions に抽出した全取引を記録（何も除外しない）
   - expectedValues にKintone期待値（過去3ヶ月分）を記録

3. 【フェーズ2: 全体最適化照合】
   - 全取引と全期待値を俯瞰して、最適な組み合わせを判定
   - **重要**: 月ごとに個別判断せず、全体で最適解を見つける

   **照合の原則:**
   - 各取引は1つの期待値にのみ対応（重複使用禁止）
   - **金額優先**: 期待値±1,000円以内なら、企業名は部分一致で可
   - 日付は柔軟に対応（前月末～翌月初も含む）
   - 1つの入金を分割して複数月に割り当てない（1入金=1期待値 or unmatchedへ）

   **分割入金の柔軟な対応:**
   - 月内分割: 同月内の複数入金を合算
   - 月またぎ分割: 前月末±7日、当月初±7日の入金を合算
   - 複数月分割: 前後の月の入金も含めて合算可能
   - 前払い/後払い: 期待月の前後1ヶ月以内の入金も考慮

   **例) 複雑なケース:**

   全取引:
   - 07-04: 1,000,000円
   - 07-31: 5,000,000円
   - 08-20: 1,500,000円
   - 09-04: 1,600,000円

   期待値:
   - 2025-08: 1,000,000円
   - 2025-09: 6,500,000円
   - 2025-10: 1,600,000円

   最適解:
   - 07-04の1,000,000円 → 8月期待値と一致
   - 07-31の5,000,000円 + 08-20の1,500,000円 = 6,500,000円 → 9月期待値と一致（月またぎ分割）
   - 09-04の1,600,000円 → 10月期待値と一致

   **matchType分類:**
   - 単独一致: 1回の入金で期待値と一致 → matchedTransactionsに1件含める
   - 月内分割: 同月内の複数入金で期待値と一致 → matchedTransactionsに全件含める
   - 月またぎ分割: 前月末～当月初の入金で期待値と一致 → matchedTransactionsに全件含める
   - 複数月分割: 複数月にまたがる入金で期待値と一致 → matchedTransactionsに全件含める
   - 前払い/後払い: 期待月の前後1ヶ月の入金で一致 → matchedTransactionsに全件含める
   - 不一致: 期待値と一致する入金が見つからない → matchedTransactionsは空配列

   **絶対厳守**:
   1. actualSourceは必須フィールド。必ず値を設定すること
      - matched=true: 「¥金額 ← 振込元名」形式（例: 「¥1,000,000 ← カ)〇〇工務店」）
      - 分割の場合: 「+」で連結（例: 「¥500万 ← カ)〇〇 + ¥150万 ← カ)〇〇」）
      - matched=false: 「検出なし」
   2. matched=trueの場合、matchedTransactionsに必ず取引を含めること（空配列禁止）
   3. 単独一致でも matchedTransactions に1件含めること
   4. 分割入金の場合、matchedTransactions に合算した全取引を含めること
   5. matched=falseの場合のみ、matchedTransactionsを空配列にできる

   **unmatchedTransactionsの判定:**
   - どの期待値にも対応できなかった取引
   - 期待値に対応済みだが、金額が過剰な部分（1つの入金を分割しない）

   **出力例（単独一致）:**
   {
     "month": "2025-08",
     "expectedAmount": 1000000,
     "totalMatched": 1000000,
     "matched": true,
     "matchType": "単独一致",
     "actualSource": "1,000,000円 ← カ)〇〇工務店",
     "matchedTransactions": [
       {"date": "07-04", "amount": 1000000, "payerName": "カ)〇〇工務店"}
     ],
     "unmatchedTransactions": []
   }

   **出力例（月またぎ分割）:**
   {
     "month": "2025-09",
     "expectedAmount": 6500000,
     "totalMatched": 6500000,
     "matched": true,
     "matchType": "月またぎ分割",
     "actualSource": "5,000,000円 ← カ)〇〇工務店 + 1,500,000円 ← カ)〇〇工務店",
     "matchedTransactions": [
       {"date": "07-31", "amount": 5000000, "payerName": "カ)〇〇工務店"},
       {"date": "08-20", "amount": 1500000, "payerName": "カ)〇〇工務店"}
     ],
     "unmatchedTransactions": []
   }

   **出力例（不一致）:**
   {
     "month": "2025-08",
     "expectedAmount": 1500000,
     "totalMatched": 0,
     "matched": false,
     "matchType": "不一致",
     "actualSource": "検出なし",
     "matchedTransactions": [],
     "unmatchedTransactions": []
   }
```

### 【簡略版】担保照合ルール（約50行）

```plaintext
2. 担保企業からの入金照合
   **照合原則:**
   - 金額優先: 期待値±1,000円以内なら企業名は部分一致でOK
   - 企業名の表記ゆれを考慮（法人格、カナ/漢字、略称を無視）
   - 分割入金を検出: 同月内または月またぎ（前月末±7日、当月初±7日）の複数入金を合算
   - 前払い/後払いを考慮: 期待月の前後1ヶ月以内の入金も照合対象

   **matchType分類:**
   - 単独一致: 1回の入金で期待値と一致
   - 月内分割/月またぎ分割: 複数入金を合算して期待値と一致
   - 不一致: 期待値と一致する入金が見つからない

   **必須フィールド:**
   - actualSource: matched=trueなら「¥金額 ← 振込元名」、分割なら「+」で連結、matched=falseなら「検出なし」
   - matchedTransactions: matched=trueなら照合できた取引を全て含める（空配列禁止）

   **出力例:**
   単独一致: {"month": "2025-08", "expectedAmount": 1000000, "totalMatched": 1000000, "matched": true, "matchType": "単独一致", "actualSource": "1,000,000円 ← カ)〇〇工務店", "matchedTransactions": [{"date": "07-04", "amount": 1000000, "payerName": "カ)〇〇工務店"}]}

   月またぎ分割: {"month": "2025-09", "expectedAmount": 6500000, "totalMatched": 6500000, "matched": true, "matchType": "月またぎ分割", "actualSource": "5,000,000円 ← カ)〇〇 + 1,500,000円 ← カ)〇〇", "matchedTransactions": [{"date": "07-31", "amount": 5000000, "payerName": "カ)〇〇"}, {"date": "08-20", "amount": 1500000, "payerName": "カ)〇〇"}]}
```

**削減効果**: 約100行 → 約50行（**-50%**）

---

## 3️⃣ ギャンブル検出ルールの簡潔化

### 【現在】ギャンブル検出ルール（約70行）

```plaintext
4. ギャンブルリスク検出
   【重要な前提】
   1. キーワードが**主要な部分として**含まれている出金取引のみ検出
   2. クレジットカード会社や決済代行業者経由の取引は除外
   3. 企業名に偶然キーワードが含まれる場合は除外

   【判定プロセス】
   ## ステップ1: キーワードの一致確認
   - 振込先/摘要に上記キーワードリストのいずれかが含まれているか確認
   - 含まれていない → 検出しない

   ## ステップ2: 決済経路の確認
   - クレジットカード会社（SMBC、AP、アプラス、JCB、VISAなど）経由 → 検出しない
   - 決済代行業者（GMO、SBペイメント、PAY.JPなど）経由 → 検出しない
   - 税金・公金サービス（RKS、ZH、地方税など）経由 → 検出しない
   - 銀行引き落とし（口座振替、自動引き落とし） → 検出しない

   ## ステップ3: キーワードの文脈確認
   - 企業名に偶然含まれる場合 → 検出しない
     例: 「マルハニチロ」の「マルハン」、「ダイナミック建設」の「ダイナム」
   - ギャンブル業者への直接送金 → 検出する

   ## ステップ4: 最終判定
   - ステップ1-3を総合して判定
   - キーワードが主要部分で、直接送金の場合のみ検出

   【Few-Shot Examples（6個）】
   [上記参照]
```

### 【簡略版】ギャンブル検出ルール（約30行）

```plaintext
3. ギャンブルリスク検出
   **検出条件:**
   - キーワードが主要部分として含まれる出金取引のみ検出
   - 除外: クレカ/決済代行経由（SMBC、GMO、JCB等）、税金/公金サービス（RKS、地方税等）、口座振替、企業名に偶然含まれるケース（「マルハニチロ」の「マルハン」等）

   【Few-Shot Examples（2個）】
   [上記参照]
```

**削減効果**: 約70行 → 約30行（**-57%**）

---

## 📈 推定効果

### トークン数
- **現在**: 約230行 × 4文字/トークン ≈ **920トークン** (ルール部分のみ)
- **簡略版**: 約120行 × 4文字/トークン ≈ **480トークン** (ルール部分のみ)
- **削減**: **-440トークン (-48%)**

### 処理時間
- **現在**: 150-170秒 (メインAI分析)
- **簡略版推定**: **90-110秒 (メインAI分析)** ← 約40%短縮
- **全体推定**: 200秒 → **120-140秒** ← 約30-40%短縮

---

## ⚠️ 注意点

### 精度への影響
- Few-Shot削減により、エッジケースの判定精度が若干低下する可能性あり
- 特にギャンブル検出で「クレカ経由を誤検出」するケースが増える可能性

### 推奨事項
1. まず簡略版で実行して精度を確認
2. 誤検出が多い場合は、Few-Shotを1-2個追加
3. ルール説明の簡潔化は精度への影響が少ないため優先実施
